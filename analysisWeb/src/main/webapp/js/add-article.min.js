var AddArticle={editor:void 0,rewardEditor:void 0,recordThought:function(e,t){for(var a=JsDiff.diffChars(e,event.target.value),i=0,r=!1,l=!1,o="",c=a.length,n=0;n<c;n++)a[n].removed?r=!0:a[n].added?(l=!0,o+=a[n].value):r||l||(i+=a[n].count),a[n].removed||a[n].added||n===c-1||0===n||(o+=a[n].value);if(r||l){var s=function(e,t){var a={ch:0,line:0},i=e.substr(0,t).split("\n");return a.line=i.length-1,a.ch=i.slice(-1).pop().length,a},d="",g=s(e,i),p=s(e,e.length-(a.slice(-1).pop().removed?0:a.slice(-1).pop().count)),u=String.fromCharCode(31),h=(new Date).getTime()-t.thoughtTime;r&&!l?d=String.fromCharCode(24)+u+h+u+g.ch+"-"+g.line+u+p.ch+"-"+p.line+String.fromCharCode(30):(l&&(d+=o),r&&(d+=String.fromCharCode(29)),d+=u+h+u+g.ch+"-"+g.line+u+p.ch+"-"+p.line+String.fromCharCode(30)),t.thoughtContent+=d}},remove:function(e,a){confirm(Label.confirmRemoveLabel)&&$.ajax({url:Label.servePath+"/article/"+Label.articleOId+"/remove",type:"POST",headers:{csrfToken:e},cache:!1,beforeSend:function(){$(a).attr("disabled","disabled").css("opacity","0.3")},error:function(e,t,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(e,t){$(a).removeAttr("disabled").css("opacity","1"),0===e.sc?window.location.href=Label.servePath+"/member/"+Label.userName:$("#addArticleTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},complete:function(){$(a).removeAttr("disabled").css("opacity","1")}})},add:function(e,a){if(Validate.goValidate({target:$("#addArticleTip"),data:[{type:"string",max:256,msg:Label.articleTitleErrorLabel,target:$("#articleTitle")}]})){var t=parseInt($("input[type='radio'][name='articleType']:checked").val());if(5!==t&&$("#articleRewardPoint").data("orval")&&!/^\+?[1-9][0-9]*$/.test($("#articleRewardPoint").val()))return $("#addArticleTip").addClass("error").html("<ul><li>"+Label.articleRewardPointErrorLabel+"</li></ul>"),!1;var i="";$(".tags-input .tag .text").each(function(){i+=$(this).text()+","});var r={articleTitle:$("#articleTitle").val().replace(/(^\s*)|(\s*$)/g,""),articleContent:this.editor.getValue(),articleTags:i,articleCommentable:$("#articleCommentable").prop("checked"),articleNotifyFollowers:$("#articleNotifyFollowers").prop("checked"),articleType:t};5!==t?(r.articleRewardContent=this.rewardEditor.getValue(),r.articleRewardPoint=$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,""),r.articleAnonymous=$("#articleAnonymous").prop("checked")):r.articleQnAOfferPoint=$("#articleAskPoint").val().replace(/(^\s*)|(\s*$)/g,"");var l=Label.servePath+"/article",o="POST";3===parseInt(r.articleType)&&(r.articleContent=JSON.parse(window.localStorage.postData).thoughtContent),Label.articleOId&&(l=l+"/"+Label.articleOId,o="PUT"),$.ajax({url:l,type:o,headers:{csrfToken:e},cache:!1,data:JSON.stringify(r),beforeSend:function(){$(a).attr("disabled","disabled").css("opacity","0.3")},error:function(e,t,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(e,t){$(a).removeAttr("disabled").css("opacity","1"),0===e.sc?(window.location.href=Label.servePath+"/article/"+e.articleId,localStorage.removeItem("postData"),AddArticle.editor.clearCache(),AddArticle.rewardEditor.clearCache()):$("#addArticleTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},complete:function(){$(a).removeAttr("disabled").css("opacity","1")}})}},init:function(){$.ua.set(navigator.userAgent),-1<location.search.indexOf("?id=")&&localStorage.removeItem("postData");var e=void 0;localStorage.postData?e=JSON.parse(localStorage.postData):(e={title:"",content:"",tags:"",thoughtContent:"",rewardContent:"",rewardPoint:"",thoughtTime:(new Date).getTime()},localStorage.postData=JSON.stringify(e)),""!==e.content&&$("#articleContent").val(e.content);var t=e.content;if(AddArticle.editor=Util.newVditor({id:"articleContent",cache:!Label.articleOId,preview:{show:!0},resize:{enable:!1},height:360,counter:4096,placeholder:$("#articleContent").data("placeholder"),input:function(){if(3===Label.articleType){var e=JSON.parse(localStorage.postData);t=localStorage.getItem("vditorarticleContent")||"",AddArticle.recordThought(t,e),localStorage.postData=JSON.stringify(e)}}}),-1!==location.href.indexOf("at=")){if(""==e.content){var a=AddArticle.editor.getValue();AddArticle.editor.setValue("\n\n\n"+a)}if(""==e.title){var i=Util.getParameterByName("at");$("#articleTitle").val("Hi, "+i)}if(""!==e.tags){var r=Label.discussionLabel,l=Util.getParameterByName("tags");""!==l&&(r+=","+l),$("#articleTags").val(r)}}if(""==e.title){var o=Util.getParameterByName("title");o&&0<o.length&&$("#articleTitle").val(o)}""!==e.title&&$("#articleTitle").val(e.title),$("#articleTitle").keyup(function(){var e=JSON.parse(localStorage.postData);e.title=$(this).val(),localStorage.postData=JSON.stringify(e)}),""!==e.tags&&$("#articleTags").val(e.tags),this._initTag(),""!==$("#articleContent").next().val()&&AddArticle.editor.setValue($("#articleContent").next().val()),$("#articleTitle").val().length<=0&&$("#articleTitle").focus(),$("#articleTitle").blur(function(){if(""===$.trim($(this).val()))return!1;1!==Label.articleType&&$.ajax({url:Label.servePath+"/article/check-title",type:"POST",data:JSON.stringify({articleTitle:$.trim($(this).val()),articleId:Label.articleOId}),success:function(e,t){e.sc?$("#articleTitleTip").remove():1===$("#articleTitleTip").length?$("#articleTitleTip").html(e.msg):$("#articleTitle").after('<div class="module" id="articleTitleTip">'+e.msg+"</div>")}})}),$("#articleTags, #articleRewardPoint, #articleAskPoint").keypress(function(e){if(e.ctrlKey&&10===e.charCode)return AddArticle.add(),!1}),0===$("#articleAskPoint").length&&(0<$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,"")&&$("#showReward").click(),AddArticle.rewardEditor=Util.newVditor({id:"articleRewardContent",cache:!Label.articleOId,preview:{show:!1},resize:{enable:!1},height:160,counter:4096,placeholder:$("#articleRewardContent").data("placeholder")}),""!==$("#articleRewardContent").next().val()&&($("#showReward").click(),AddArticle.rewardEditor.setValue($("#articleRewardContent").next().val()))),0===$("#articleAskPoint").length?(""!==e.rewardContent&&($("#showReward").click(),AddArticle.rewardEditor.setValue(e.rewardContent)),""!==e.rewardPoint&&($("#showReward").click(),$("#articleRewardPoint").val(e.rewardPoint)),$("#articleRewardPoint").keyup(function(){var e=JSON.parse(localStorage.postData);e.rewardPoint=$(this).val(),localStorage.postData=JSON.stringify(e)})):($("#articleAskPoint").keyup(function(){var e=JSON.parse(localStorage.postData);e.QnAOfferPoint=$(this).val(),localStorage.postData=JSON.stringify(e)}),""!==e.QnAOfferPoint&&""===$("#articleAskPoint").val()&&$("#articleAskPoint").val(e.QnAOfferPoint))},_initTag:function(){$.ua.set(navigator.userAgent);var a=function(t){if(""===t.replace(/\s/g,""))return!1;var a=!1;if(t=t.replace(/\s/g,"").replace(/,/g,""),$("#articleTags").val(""),$(".tags-input .text").each(function(){var e=$(this);t===e.text()&&(e.parent().addClass("haved"),setTimeout(function(){e.parent().removeClass("haved")},900),a=!0)}),a)return!1;if(4<=$(".tags-input .tag").length)return $("#articleTags").val("").data("val",""),!1;if($(".post .tags-selected").append('<span class="tag"><span class="text">'+t+'</span><span class="close">x</span></span>'),-1===location.search.indexOf("?id=")){var e="";$(".tags-input .tag .text").each(function(){e+=$(this).text()+","});var i=JSON.parse(localStorage.postData);i.tags=e,localStorage.postData=JSON.stringify(i)}4<=$(".tags-input .tag").length&&$("#articleTags").val("").data("val","")};$(".domains-tags .btn").click(function(){$(".domains-tags .btn.current").removeClass("current green"),$(this).addClass("current").addClass("green"),$(".domains-tags .domain-tags").hide(),$("#tags"+$(this).data("id")).show()});for(var e=$("#articleTags").val().split(","),t=0,i=e.length;t<i;t++)a(e[t]);$(".domain-tags .tag").click(function(){a($(this).text())}),$(".tags-input").on("click",".tag > span.close",function(){if($(this).parent().remove(),-1===location.search.indexOf("?id=")){var e="";$(".tags-input .tag .text").each(function(){e+=$(this).text()+","});var t=JSON.parse(localStorage.postData);t.tags=e,localStorage.postData=JSON.stringify(t)}}),$("#articleTags").click(function(){$(".post .domains-tags").show(),"mobile"!==$.ua.device.type&&$(".post .domains-tags").css("left",$(".post .tags-selected").width()+10+"px"),$("#articleTagsSelectedPanel").hide()}).blur(function(){if("block"===$("#articleTagsSelectedPanel").css("display"))return!1;a($(this).val())}),$("body").click(function(e){1===$(e.target).closest(".tags-input").length||1===$(e.target).closest(".domains-tags").length||$(".post .domains-tags").hide()}),$("#articleTags").completed({height:170,onlySelect:!0,data:[],afterSelected:function(e){a(e.text())},afterKeyup:function(e){if($(".post .domains-tags").hide(),","!==e.key&&"，"!==e.key&&"、"!==e.key&&"；"!==e.key&&";"!==e.key)return 13===e.keyCode?(a($("#articleTags").val()),!1):37!==e.keyCode&&39!==e.keyCode&&38!==e.keyCode&&40!==e.keyCode&&(27===e.keyCode?($("#articleTagsSelectedPanel").hide(),!1):8===e.keyCode&&8===e.data.settings.chinese&&""===e.data.settings.keydownVal.replace(/\s/g,"")?($(".tags-input .tag .close:last").click(),!1):""!==$("#articleTags").val().replace(/\s/g,"")&&void $.ajax({url:Label.servePath+"/tags/query?title="+$("#articleTags").val(),error:function(e,t,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(e,t){e.sc?("mobile"!==$.ua.device.type&&$("#articleTagsSelectedPanel").css("left",$(".post .tags-selected").width()+10+"px"),$("#articleTags").completed("updateData",e.tags)):console.log(e)}}));var t=$("#articleTags").val();return a(t.substr(0,t.length-1)),!1}})}};AddArticle.init();